@using Microsoft.AspNetCore.Mvc.Localization
@model List<Tixxp.WebApp.Models.Counter.CounterListVm>
@inject IViewLocalizer Localizer

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="main-content app-content">
    <div class="container-fluid">

        <div class="d-md-flex d-block align-items-center justify-content-between my-4 page-header-breadcrumb text-fixed-white">
            <h1 class="page-title fw-medium fs-18 mb-0 text-fixed-white">@Localizer["counter.INDEX.TITLE"]</h1>
        </div>

        <div class="row">
            <div class="col-xl-12">
                <div class="card custom-card">
                    <div class="card-header">
                        <div class="card-title">@Localizer["counter.INDEX.COUNTER_LIST"]</div>
                    </div>

                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table text-nowrap table-hover table-bordered align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>@Localizer["counter.INDEX.COUNTER_NAME"]</th>
                                        <th>@Localizer["counter.INDEX.OKC_SERIAL"]</th>
                                        <th>@Localizer["counter.INDEX.IP"]</th>
                                        <th>@Localizer["counter.INDEX.OKC"]</th>
                                        <th>@Localizer["counter.INDEX.TSM"]</th>
                                        <th>@Localizer["counter.INDEX.GMP"]</th>
                                        <th>@Localizer["counter.INDEX.OTP"]</th>
                                        <th>@Localizer["counter.INDEX.ACTION"]</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    @if (Model != null && Model.Any())
                                    {
                                        foreach (var counter in Model)
                                        {
                                            <tr>
                                                <td>@counter.Name</td>
                                                <td>@counter.OkcFiscalSerialNumber</td>
                                                <td>@counter.IpAddress</td>

                                                <td>
                                                    <span class="badge @(counter.IsOkcIntegrated ? "bg-success-transparent" : "bg-danger-transparent")">
                                                        @(counter.IsOkcIntegrated? Localizer["counter.INDEX.ACTIVE"] : Localizer["counter.INDEX.PASSIVE"])
                                                    </span>
                                                </td>

                                                <td>
                                                    <span class="badge @(counter.TsmOpen ? "bg-success-transparent" : "bg-danger-transparent")">
                                                        @(counter.TsmOpen? Localizer["counter.INDEX.ACTIVE"] : Localizer["counter.INDEX.PASSIVE"])
                                                    </span>
                                                </td>

                                                <td>
                                                    <span class="badge @(counter.GmpOpen ? "bg-success-transparent" : "bg-danger-transparent")">
                                                        @(counter.GmpOpen? Localizer["counter.INDEX.ACTIVE"] : Localizer["counter.INDEX.PASSIVE"])
                                                    </span>
                                                </td>

                                                <td>
                                                    <span class="badge @(counter.OtpVerification ? "bg-success-transparent" : "bg-danger-transparent")">
                                                        @(counter.OtpVerification? Localizer["counter.INDEX.ACTIVE"] : Localizer["counter.INDEX.PASSIVE"])
                                                    </span>
                                                </td>

                                                <td class="text-center">
                                                    <div class="hstack gap-2">
                                                        <button class="btn btn-icon btn-sm btn-light" onclick="openEditModal(@counter.Id)" title="@Localizer["counter.INDEX.EDIT"]">
                                                            <i class="ri-edit-line"></i>
                                                        </button>
                                                        <button class="btn btn-icon btn-sm btn-light" onclick="confirmDelete(@counter.Id)" title="@Localizer["counter.INDEX.DELETE"]">
                                                            <i class="ri-delete-bin-line"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="8" class="text-center">@Localizer["counter.INDEX.NO_RECORD"]</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="editCounterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">

            <div class="modal-header bg-light p-3">
                <h5 class="modal-title">@Localizer["counter.INDEX.EDIT_COUNTER"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="editCounterForm">

                    <input type="hidden" id="editId" />

                    <div class="row">

                        <div class="col-md-6 mb-3">
                            <label class="form-label">@Localizer["counter.INDEX.COUNTER_NAME_TR"]</label>
                            <input type="text" class="form-control" id="editNameTr" required />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">@Localizer["counter.INDEX.COUNTER_NAME_EN"]</label>
                            <input type="text" class="form-control" id="editNameEn" />
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">@Localizer["counter.INDEX.OKC_SERIAL"]</label>
                            <input type="text" class="form-control" id="editSerial" />
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">@Localizer["counter.INDEX.OKC_BRAND"]</label>
                            <input type="number" class="form-control" id="editOkcBrand" />
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">@Localizer["counter.INDEX.OKC_PASSWORD"]</label>
                            <input type="text" class="form-control" id="editOkcPassword" />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">@Localizer["counter.INDEX.IP_ADDRESS"]</label>
                            <input type="text" class="form-control" id="editIp" />
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label">@Localizer["counter.INDEX.PORT"]</label>
                            <input type="number" class="form-control" id="editPort" />
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label">@Localizer["counter.INDEX.VERSION"]</label>
                            <input type="text" class="form-control" id="editVersion" />
                        </div>

                        <!-- BOOL ALANLAR -->
                        <div class="col-md-4 mb-2">
                            <label class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="editOkcIntegrated">
                                <span class="form-check-label">@Localizer["counter.INDEX.OKC_INTEGRATED"]</span>
                            </label>
                        </div>

                        <div class="col-md-4 mb-2">
                            <label class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="editTsmOpen">
                                <span class="form-check-label">@Localizer["counter.INDEX.TSM_OPEN"]</span>
                            </label>
                        </div>

                        <div class="col-md-4 mb-2">
                            <label class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="editGmpOpen">
                                <span class="form-check-label">@Localizer["counter.INDEX.GMP_OPEN"]</span>
                            </label>
                        </div>

                        <div class="col-md-4 mb-2">
                            <label class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="editOtpVerification">
                                <span class="form-check-label">@Localizer["counter.INDEX.OTP_VERIFICATION"]</span>
                            </label>
                        </div>

                    </div>

                    <button type="submit" class="btn btn-primary w-100 mt-3">
                        @Localizer["counter.INDEX.SAVE"]
                    </button>

                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>

    function openEditModal(id) {
        $.get('/Counter/GetById', { id: id }, function (resp) {

            const c = resp.counter;

            $('#editId').val(c.id);

            let tr = resp.translations.find(x => x.languageId == 1);
            let en = resp.translations.find(x => x.languageId == 2);

            $('#editNameTr').val(tr ? tr.name : "");
            $('#editNameEn').val(en ? en.name : "");

            $('#editSerial').val(c.okcFiscalSerialNumber);
            $('#editOkcBrand').val(c.okcBrand);
            $('#editOkcPassword').val(c.okcPassword);
            $('#editIp').val(c.ipAddress);
            $('#editPort').val(c.port);
            $('#editVersion').val(c.version);

            $('#editOkcIntegrated').prop('checked', c.isOkcIntegrated);
            $('#editTsmOpen').prop('checked', c.tsmOpen);
            $('#editGmpOpen').prop('checked', c.gmpOpen);
            $('#editOtpVerification').prop('checked', c.otpVerification);

            $('#editCounterModal').modal('show');

        });
    }


    $("#editCounterForm").submit(function (e) {
        e.preventDefault();

        var payload = {
            id: Number($('#editId').val()),
            okcFiscalSerialNumber: $('#editSerial').val(),
            okcBrand: Number($('#editOkcBrand').val()),
            okcPassword: $('#editOkcPassword').val(),
            ipAddress: $('#editIp').val(),
            port: Number($('#editPort').val()),
            version: $('#editVersion').val(),

            isOkcIntegrated: $('#editOkcIntegrated').is(":checked"),
            tsmOpen: $('#editTsmOpen').is(":checked"),
            gmpOpen: $('#editGmpOpen').is(":checked"),
            otpVerification: $('#editOtpVerification').is(":checked")
        };

        $.ajax({
            url: '/Counter/Update',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (res) {

                if (res.success) {
                    Swal.fire(
                        "@Localizer["counter.ALERT.SUCCESS_TITLE"]",
                        "@Localizer["counter.ALERT.UPDATE_SUCCESS"]",
                        "success"
                    ).then(() => location.reload());
                }
                else {
                    Swal.fire(
                        "@Localizer["counter.ALERT.ERROR_TITLE"]",
                        res.message,
                        "error"
                    );
                }
            }
        });

    });


    function confirmDelete(id) {

        Swal.fire({
            title: "@Localizer["counter.ALERT.DELETE_TITLE"]",
            text: "@Localizer["counter.ALERT.DELETE_TEXT"]",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "@Localizer["counter.ALERT.DELETE_CONFIRM"]",
            cancelButtonText: "@Localizer["counter.ALERT.DELETE_CANCEL"]"
        }).then((result) => {

            if (result.isConfirmed) {

                $.post('/Counter/Delete', { id: id }, function (res) {

                    if (res.success) {
                        Swal.fire(
                            "@Localizer["counter.ALERT.SUCCESS_TITLE"]",
                            "@Localizer["counter.ALERT.DELETE_SUCCESS"]",
                            "success"
                        ).then(() => location.reload());
                    }
                    else {
                        Swal.fire(
                            "@Localizer["counter.ALERT.ERROR_TITLE"]",
                            res.message,
                            "error"
                        );
                    }

                });

            }

        });

    }

</script>
