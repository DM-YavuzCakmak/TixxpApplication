@model List<Tixxp.WebApp.Models.Product.ProductWithTranslationViewModel>

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="main-content app-content">
    <div class="container-fluid">
        <div class="d-md-flex d-block align-items-center justify-content-between my-4 page-header-breadcrumb text-fixed-white">
            <h1 class="page-title fw-medium fs-18 mb-0 text-fixed-white">Ürün Listesi</h1>
            @if (User.IsInRole("TIXXP_PRODUCT_ADD"))
            {
                <button class="btn btn-primary" onclick="openEditModal(0)">+ Yeni Ürün</button>
            }
        </div>

        <div class="row">
            <div class="col-xl-12">
                <div class="card custom-card">
                    <div class="card-header">
                        <div class="card-title">Ürünler</div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered text-nowrap w-100">
                                <thead>
                                    <tr>
                                        <th>Ürün Adları (Tüm Diller)</th>
                                        <th>Kodu</th>
                                        @if (User.IsInRole("TIXXP_PRODUCT_EDIT") || User.IsInRole("TIXXP_PRODUCT_DELETE"))
                                        {
                                            <th>İşlem</th>
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model != null && Model.Any())
                                    {
                                        foreach (var item in Model)
                                        {
                                            <tr>
                                                <td>
                                                    @foreach (var t in item.Translations)
                                                    {
                                                        <div>
                                                            <strong>@t.Language?.Code.ToUpperInvariant():</strong> @t.Name
                                                        </div>
                                                    }
                                                </td>
                                                <td>@item.Product.Code</td>
                                                @if (User.IsInRole("TIXXP_PRODUCT_EDIT") || User.IsInRole("TIXXP_PRODUCT_DELETE"))
                                                {
                                                    <td>
                                                        <div class="hstack gap-2 fs-15">
                                                            @if (User.IsInRole("TIXXP_PRODUCT_EDIT"))
                                                            {
                                                                <a href="javascript:void(0);" class="btn btn-icon btn-sm btn-light"
                                                                   onclick="openEditModal(@item.Product.Id)">
                                                                    <i class="ri-edit-line"></i>
                                                                </a>
                                                            }
                                                            @if (User.IsInRole("TIXXP_PRODUCT_DELETE"))
                                                            {
                                                                <a href="javascript:void(0);" class="btn btn-icon btn-sm btn-light"
                                                                   onclick="confirmDelete(@item.Product.Id)">
                                                                    <i class="ri-delete-bin-line"></i>
                                                                </a>
                                                            }
                                                        </div>
                                                    </td>
                                                }
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr><td colspan="3" class="text-center">Kayıt bulunamadı.</td></tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit / Add Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="productForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Ürün Bilgileri</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="Id" id="ProductId" />

                    <div class="mb-3">
                        <label class="form-label">Ürün Adı</label>
                        <input type="text" class="form-control" name="Name" id="ProductName" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ürün Kodu</label>
                        <input type="text" class="form-control" name="Code" id="ProductCode" required />
                    </div>

                    <div id="translationInputs">
                        <!-- Diller dinamik olarak JS ile eklenebilir -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Kaydet</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                </div>
            </form>
        </div>
    </div>
</div>




@section Scripts {
    <script>
        function openEditModal(id) {
            // Temizle
            $('#productForm')[0].reset();
            $('#ProductId').val(0);
            $('#translationInputs').html('');

            if (id === 0) {
                $('#productModalLabel').text('Yeni Ürün Ekle');
                $('#productModal').modal('show');
                // Dil inputlarını oluştur
                addTranslationInputs();
            } else {
                $('#productModalLabel').text('Ürünü Düzenle');

                $.get(`/Product/GetById/${id}`, function (data) {
                    $('#ProductId').val(data.Product.Id);
                    $('#ProductCode').val(data.Product.Code);

                    $('#translationInputs').html('');
                    data.Translations.forEach(function (t) {
                        $('#translationInputs').append(`
                            <div class="mb-2">
                              <label>${t.Language.Code.toUpperCase()}</label>
                              <input type="text" class="form-control" name="Translations[${t.Language.Code}]" value="${t.Name}" />
                            </div>
                        `);
                    });

                    $('#productModal').modal('show');
                });
            }
        }

        function addTranslationInputs() {
            const languages = ['tr', 'en', 'de']; // ihtiyaca göre çoğalt
            languages.forEach(lang => {
                $('#translationInputs').append(`
                    <div class="mb-2">
                        <label>${lang.toUpperCase()}</label>
                        <input type="text" class="form-control" name="Translations[${lang}]" />
                    </div>
                `);
            });
        }

        $('#productForm').on('submit', function (e) {
            e.preventDefault();
            const formData = $(this).serialize();

            $.post('/Product/Save', formData, function () {
                location.reload(); // Başarılıysa sayfayı yenile
            }).fail(function (xhr) {
                alert('Hata oluştu: ' + xhr.responseText);
            });
        });

        function confirmDelete(id) {
            if (confirm("Bu ürünü silmek istediğinize emin misiniz?")) {
                $.post(`/Product/Delete/${id}`, function () {
                    location.reload();
                }).fail(function (xhr) {
                    alert('Silme işlemi başarısız: ' + xhr.responseText);
                });
            }
        }
    </script>
}
