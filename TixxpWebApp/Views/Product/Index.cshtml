@using Microsoft.AspNetCore.Mvc.Localization
@model List<Tixxp.WebApp.Models.Product.ProductWithTranslationViewModel>
@inject IViewLocalizer Localizer
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="main-content app-content">
    <div class="container-fluid">
        <div class="d-md-flex d-block align-items-center justify-content-between my-4 page-header-breadcrumb text-fixed-white">
            <h1 class="page-title fw-medium fs-18 mb-0 text-fixed-white">
                @Localizer["product.INDEX.PAGE_TITLE"]
            </h1>

            @if (User.IsInRole("TIXXP_PRODUCT_ADD"))
            {
                <button class="btn btn-primary" onclick="openEditModal(0)">
                    @Localizer["product.INDEX.NEW_PRODUCT"]
                </button>
            }
        </div>

        <div class="row">
            <div class="col-xl-12">
                <div class="card custom-card">
                    <div class="card-header">
                        <div class="card-title">@Localizer["product.INDEX.TABLE_TITLE"]</div>
                    </div>

                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered text-nowrap w-100">
                                <thead>
                                    <tr>
                                        <th>@Localizer["product.INDEX.PRODUCT_NAMES_ALL_LANG"]</th>
                                        <th>@Localizer["product.INDEX.PRODUCT_CODE"]</th>

                                        @if (User.IsInRole("TIXXP_PRODUCT_EDIT") || User.IsInRole("TIXXP_PRODUCT_DELETE"))
                                        {
                                            <th>@Localizer["product.INDEX.ACTION"]</th>
                                        }
                                    </tr>
                                </thead>

                                <tbody>
                                    @if (Model != null && Model.Any())
                                    {
                                        foreach (var item in Model)
                                        {
                                            <tr>
                                                <td>
                                                    @foreach (var t in item.Translations)
                                                    {
                                                        <div>
                                                            <strong>@t.Language?.Code.ToUpperInvariant():</strong> @t.Name
                                                        </div>
                                                    }
                                                </td>

                                                <td>@item.Product.Code</td>

                                                @if (User.IsInRole("TIXXP_PRODUCT_EDIT") || User.IsInRole("TIXXP_PRODUCT_DELETE"))
                                                {
                                                    <td>
                                                        <div class="hstack gap-2 fs-15">
                                                            @if (User.IsInRole("TIXXP_PRODUCT_EDIT"))
                                                            {
                                                                <a href="javascript:void(0);" class="btn btn-icon btn-sm btn-light"
                                                                   onclick="openEditModal(@item.Product.Id)">
                                                                    <i class="ri-edit-line"></i>
                                                                </a>
                                                            }

                                                            @if (User.IsInRole("TIXXP_PRODUCT_DELETE"))
                                                            {
                                                                <a href="javascript:void(0);" class="btn btn-icon btn-sm btn-light"
                                                                   onclick="confirmDelete(@item.Product.Id)">
                                                                    <i class="ri-delete-bin-line"></i>
                                                                </a>
                                                            }
                                                        </div>
                                                    </td>
                                                }
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="3" class="text-center">
                                                @Localizer["product.INDEX.NO_RECORD"]
                                            </td>
                                        </tr>
                                    }
                                </tbody>

                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

<!-- Edit / Add Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <form id="productForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">@Localizer["product.MODAL.TITLE"]</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                            aria-label="@Localizer["product.MODAL.CLOSE"]"></button>
                </div>

                <div class="modal-body">

                    <input type="hidden" name="Id" id="ProductId" />

                    <div class="mb-3">
                        <label class="form-label">@Localizer["product.MODAL.PRODUCT_NAME"]</label>
                        <input type="text" class="form-control" name="Name" id="ProductName" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">@Localizer["product.MODAL.PRODUCT_CODE"]</label>
                        <input type="text" class="form-control" name="Code" id="ProductCode" required />
                    </div>

                    <div id="translationInputs"></div>

                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">@Localizer["product.MODAL.SAVE"]</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        @Localizer["product.MODAL.CANCEL"]
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
@section Scripts {
    <script>
        function openEditModal(id) {

            $('#productForm')[0].reset();
            $('#ProductId').val(0);
            $('#translationInputs').html('');

            if (id === 0) {
                $('#productModalLabel').text('@Localizer["product.MODAL.ADD_NEW"]');
                $('#productModal').modal('show');
                addTranslationInputs();
            } else {
                $('#productModalLabel').text('@Localizer["product.MODAL.EDIT"]');

                     $.get(`/Product/GetById/${id}`, function (data) {

            $('#ProductId').val(data.product.id);
            $('#ProductCode').val(data.product.code);

            $('#translationInputs').html('');

            let defaultName = "";

            data.translations.forEach(function (t) {

                const lang = t.language.code.toLowerCase();

                if (lang === "tr-tr" || lang === "tr") {
                    defaultName = t.name;
                }

                $('#translationInputs').append(`
                    <div class="mb-2">
                        <label>${t.language.code.toUpperCase()}</label>
                        <input type="text" class="form-control"
                               name="Translations[${lang}]" value="${t.name}" />
                    </div>
                `);
            });

            $('#ProductName').val(defaultName);

            $('#productModal').modal('show');
        });
            }
        }

        function addTranslationInputs() {
            const languages = ['tr', 'en'];

            languages.forEach(lang => {
                $('#translationInputs').append(`
                    <div class="mb-2">
                        <label>${lang.toUpperCase()}</label>
                        <input type="text" class="form-control" name="Translations[${lang}]" />
                    </div>
                `);
            });
        }

        $('#productForm').on('submit', function (e) {
            e.preventDefault();

            $.post('/Product/Save', $(this).serialize(), function () {
                location.reload();
            }).fail(function (xhr) {
                alert('@Localizer["product.ERROR.SAVE_FAILED"]: ' + xhr.responseText);
            });
        });

                function confirmDelete(id) {

            // Ürün bilgisi almak için GetById çağırıyoruz
            $.get(`/Product/GetById/${id}`, function (res) {

                const productName =
                    res.translations?.find(t => t.language.code.toLowerCase().startsWith("tr"))?.name
                    ?? res.translations?.[0]?.name
                    ?? "-";

                const productCode = res.product.code ?? "-";

                Swal.fire({
                    title: '@Localizer["product.DELETE.TITLE"]',
                    html: `
                        <div style="font-size:15px; margin-top:10px;">
                            <strong>@Localizer["product.DELETE.PRODUCT"]:</strong> ${productName}<br/>
                            <strong>@Localizer["product.DELETE.CODE"]:</strong> ${productCode}
                        </div>
                    `,
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "@Localizer["product.DELETE.CONFIRM_BUTTON"]",
                    cancelButtonText: "@Localizer["product.DELETE.CANCEL_BUTTON"]",
                    confirmButtonColor: "#d33",
                    cancelButtonColor: "#3085d6",
                    reverseButtons: true
                }).then(result => {

                    if (!result.isConfirmed) return;

                    $.post(`/Product/Delete/${id}`, function (res) {

                        if (res.success) {
                            Swal.fire({
                                icon: "success",
                                title: "@Localizer["product.DELETE.SUCCESS"]",
                                timer: 1500,
                                showConfirmButton: false
                            }).then(() => location.reload());
                        } else {
                            Swal.fire("Hata", "@Localizer["product.ERROR.DELETE_FAILED"]", "error");
                        }

                    }).fail(() => {
                        Swal.fire("Hata", "@Localizer["product.ERROR.DELETE_FAILED"]", "error");
                    });

                });

            });
        }
    </script>
}
