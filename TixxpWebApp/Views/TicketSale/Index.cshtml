@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer;
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="main-content app-content">
    <div class="container-fluid">

        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center my-4 page-header-breadcrumb text-fixed-white">
            <h1 class="page-title fw-medium fs-18 mb-0 text-fixed-white">@Localizer["ticketSale.INDEX.SELL_TICKET"]</h1>
        </div>

        <div class="card custom-card">
            <div class="card-body p-0 product-checkout">
                <!-- Tabs -->
                <ul class="nav nav-tabs tab-style-2 border-bottom" id="tabNavigation" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="event-tab" data-bs-toggle="tab" data-bs-target="#event-pane" type="button" role="tab">@Localizer["ticketSale.INDEX.EVENT"]</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="date-tab" data-bs-toggle="tab" data-bs-target="#date-pane" type="button" role="tab">@Localizer["ticketSale.INDEX.DATE"]</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail-pane" type="button" role="tab">@Localizer["ticketSale.INDEX.DETAILS"]</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="confirmation-tab" data-bs-toggle="tab" data-bs-target="#confirmation-pane" type="button" role="tab">@Localizer["ticketSale.INDEX.CONFIRMATION"]</button>
                    </li>
                </ul>

                <!-- Tab Contents -->
                <div class="tab-content p-4">
                    <!-- EVENT -->
                    <div class="tab-pane fade show active" id="event-pane" role="tabpanel">
                        <div class="row" id="event-list"></div>
                    </div>

                    <!-- DATE -->
                    <div class="tab-pane fade" id="date-pane" role="tabpanel">
                        <div class="row" id="session-list"></div>
                    </div>

                    <!-- DETAILS TAB -->
                    <div class="tab-pane fade" id="detail-pane" role="tabpanel">
                        <form id="dummy-form">
                            <div class="row">
                                <!-- LEFT SIDE -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label>Reservation Type</label>
                                        <select class="form-select">
                                            <option value="1">Individual</option>
                                            <option value="2">Group</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label>Reservation Subtype</label>
                                        <select class="form-select">
                                            <option>Corporate</option>
                                            <option>Historical & Cultural</option>
                                            <option>Incentive</option>
                                            <option>Private Group</option>
                                            <option>Tour Series</option>
                                        </select>
                                    </div>
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="guideCheckbox" onchange="toggleGuideList()">
                                        <label class="form-check-label" for="guideCheckbox">Guide Required?</label>
                                    </div>

                                    <div class="mb-3" id="guideContainer" style="display: none;">
                                        <label>Select Guide</label>
                                        <select class="form-select">
                                            <option value="101">Ali Demir</option>
                                            <option value="102">Ayşe Yılmaz</option>
                                            <option value="103">John Smith</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label>Nationality</label>
                                        <select class="form-select">
                                            <option>Turkey</option>
                                            <option>USA</option>
                                            <option>Germany</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label>Payment Type</label>
                                        <select class="form-select">
                                            <option>Credit Card</option>
                                            <option>Cash</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label>Ticket Type</label>
                                        <select class="form-select" id="ticketTypeSelect" onchange="updatePrice()">
                                            <option value="250">Full Ticket - Foreign</option>
                                            <option value="100">Full Ticket - Local</option>
                                            <option value="0">Free</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label>Quantity</label>
                                        <div class="qty-container d-flex">
                                            <button type="button" class="btn btn-outline-secondary" onclick="adjustQty(-1)">-</button>
                                            <input type="text" class="form-control text-center mx-2" id="ticketQty" value="1" style="width: 60px;" readonly />
                                            <button type="button" class="btn btn-outline-secondary" onclick="adjustQty(1)">+</button>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label>Currency</label>
                                        <select class="form-select">
                                            <option>₺ Turkish Lira</option>
                                            <option>$ US Dollar</option>
                                            <option>€ Euro</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label>Total Amount</label>
                                        <input type="text" class="form-control" id="totalAmount" value="250" readonly />
                                    </div>
                                </div>

                                <!-- RIGHT SIDE -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label>First Name</label>
                                        <input type="text" class="form-control" placeholder="Your name" />
                                    </div>
                                    <div class="mb-3">
                                        <label>Last Name</label>
                                        <input type="text" class="form-control" placeholder="Your surname" />
                                    </div>
                                    <div class="mb-3">
                                        <label>Email</label>
                                        <input type="email" class="form-control" placeholder="your@email.com" />
                                    </div>
                                    <div class="mb-3">
                                        <label>Phone</label>
                                        <input type="tel" class="form-control" placeholder="5xxxxxxxxx" />
                                    </div>
                                    <div class="mb-3">
                                        <label>Notes</label>
                                        <textarea class="form-control" rows="3" readonly>
Purchased tickets are valid for 15 days from the event start date. No refunds.
                    </textarea>
                                    </div>
                                    <div class="mb-3 form-check">
                                        <input class="form-check-input" type="checkbox" id="agreementCheck" required />
                                        <label class="form-check-label" for="agreementCheck">
                                            I have read and agree to the <a href="#">Distance Sales Agreement</a>.
                                        </label>
                                    </div>

                                    <div class="d-flex justify-content-end">
                                        <button type="reset" class="btn btn-outline-danger me-2">Cancel</button>
                                        <button type="button" class="btn btn-primary" onclick="goToConfirmation()">Buy Ticket</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- CONFIRMATION -->
                    <div class="tab-pane fade" id="confirmation-pane" role="tabpanel">
                        <div class="text-center">
                            <h4 class="text-success mb-3">Your ticket has been created successfully!</h4>
                            <p class="mb-4">Thank you for your reservation. You can print or view your ticket below.</p>
                            <a href="/TicketSale/Index" class="btn btn-warning me-2">Buy Ticket</a>
                            <a href="#" class="btn btn-primary">Print Ticket</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>

                function toggleGuideList() {
            const guideContainer = document.getElementById("guideContainer");
            const checkbox = document.getElementById("guideCheckbox");
            guideContainer.style.display = checkbox.checked ? "block" : "none";
        }

        function updatePrice() {
            const selectedPrice = parseInt(document.getElementById("ticketTypeSelect").value);
            const qty = parseInt(document.getElementById("ticketQty").value);
            document.getElementById("totalAmount").value = selectedPrice * qty;
        }

        function adjustQty(amount) {
            const qtyInput = document.getElementById("ticketQty");
            let qty = parseInt(qtyInput.value);
            qty = Math.max(0, qty + amount);
            qtyInput.value = qty;
            updatePrice();
        }   
        const dummyEvents = [
            { id: "1", name: "Kariye Camii", startTime: "10:00", endTime: "18:00", imagePath: "images/product/chora.jpeg" },
        ];

        const dummySessions = [
            { sessionId: "101", eventDate: new Date(), plannedTime: "12:00", isCancelled: false },
            { sessionId: "102", eventDate: new Date(), plannedTime: "15:00", isCancelled: true }
        ];

        // On page load
        document.addEventListener("DOMContentLoaded", () => {
            loadEventData(dummyEvents);
        });

        // Load event cards
        function loadEventData(data) {
            const list = document.getElementById("event-list");
            list.innerHTML = "";
            data.forEach(event => {
                list.innerHTML += `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card">
                            <img src="/assets/${event.imagePath}" class="card-img-top" style="height: 200px; object-fit: cover;">
                            <div class="card-body text-center">
                                <h5>${event.name}</h5>
                                <p>@Localizer["ticketSale.INDEX.START"]: ${event.startTime} - @Localizer["ticketSale.INDEX.END"]: ${event.endTime}</p>
                                <button class="btn btn-primary" onclick="goToDateTab()">View Dates</button>
                            </div>
                        </div>
                    </div>`;
            });
        }

        // Switch to Date tab and load sessions
        function goToDateTab() {
            switchTab("event", "date");
            loadSessionData(dummySessions);
        }

        // Load session cards
        function loadSessionData(data) {
            const list = document.getElementById("session-list");
            list.innerHTML = "";
            data.forEach(session => {
                list.innerHTML += `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card ${session.isCancelled ? 'border-danger' : ''}">
                            <div class="card-body">
                                <h5>Date: ${new Date(session.eventDate).toLocaleDateString('en-US')}</h5>
                                <p>Time: ${session.plannedTime}</p>
                                <span class="badge ${session.isCancelled ? 'bg-danger' : 'bg-success'}">
                                    ${session.isCancelled ? 'Cancelled' : 'Available'}
                                </span>
                                ${!session.isCancelled ? `<div class="mt-3"><button class="btn btn-success" onclick="goToDetailTab()">Select</button></div>` : ''}
                            </div>
                        </div>
                    </div>`;
            });
        }

        // Switch to Details tab
        function goToDetailTab() {
            switchTab("date", "detail");
        }

        // On "Buy Ticket", validate and show confirmation
        function goToConfirmation() {
            const agreement = document.getElementById("agreementCheck");
            if (!agreement.checked) {
                alert("You must agree to the Distance Sales Agreement.");
                return;
            }

            switchTab("detail", "confirmation");
        }

        // Generic tab switcher
        function switchTab(current, next) {
            document.getElementById(`${current}-pane`).classList.remove("active", "show");
            document.getElementById(`${current}-tab`).classList.remove("active");
            document.getElementById(`${next}-pane`).classList.add("active", "show");
            document.getElementById(`${next}-tab`).classList.add("active");
        }
    </script>
}
