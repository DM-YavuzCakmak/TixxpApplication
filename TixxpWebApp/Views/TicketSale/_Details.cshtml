@model IEnumerable<Tixxp.Entities.EventTicketPrice.EventTicketPriceEntity>
@using System.Text.Json
@using Microsoft.AspNetCore.Mvc.Localization
@using Tixxp.WebApp.Models.ProductPrice
@inject IViewLocalizer Localizer

@{
    // Controller’dan gelen ViewBag verileri
    var paymentTypes = ViewBag.PaymentTypes as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var countries = ViewBag.Countries as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var cities = ViewBag.Cities as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var counties = ViewBag.Counties as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();

    // Ek Ürünler
    var products = ViewBag.Products as IEnumerable<ProductWithPriceViewModel> ?? Enumerable.Empty<ProductWithPriceViewModel>();
    var hasProducts = products.Any();

    // Para birimlerini tekilleştir (biletler için)
    var currencyOptions = Model?
        .Where(m => m?.CurrencyType != null)
        .GroupBy(m => m.CurrencyType.Id)
        .Select(g => g.First().CurrencyType)
        .ToList() ?? new List<Tixxp.Entities.CurrencyType.CurrencyTypeEntity>();

    // GEO payload (Country/City/County kümeleri)
    var geoPayload = new { countries, cities, counties };
    var json = JsonSerializer.Serialize(
        geoPayload,
        new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase }
    );

    var hasTickets = Model != null && Model.Any();
}

<style>
    .elegant-card {
        border: 0;
        border-radius: 1rem;
        box-shadow: 0 8px 24px rgba(0,0,0,.08);
        overflow: hidden;
    }

        .elegant-card .card-header {
            border: 0;
            padding: .9rem 1.1rem;
            font-weight: 700;
            letter-spacing: .3px;
        }

    .hd-gradient-blue {
        background: linear-gradient(135deg,#5B7CFF 0%,#6EDCFF 100%);
        color: #fff;
    }

    .hd-gradient-purple {
        background: linear-gradient(135deg,#7C4DFF 0%,#B47DFF 100%);
        color: #fff;
    }

    .hd-gradient-teal {
        background: linear-gradient(135deg,#00C2A8 0%,#58E1C1 100%);
        color: #fff;
    }

    .form-label {
        font-weight: 600;
    }

    .qty-wrap .btn {
        min-width: 36px;
    }

    .card-divider {
        height: 1px;
        background: rgba(0,0,0,.06);
        margin: 1rem 0;
    }

    /* Ürün kartları */
    .prod-card.card {
        border: 1px solid rgba(0,0,0,.06);
        border-radius: .9rem;
        height: 100%;
    }

    .prod-title {
        font-weight: 600;
    }

    .prod-code {
        opacity: .7;
        font-size: .85rem;
    }

    .price-chip {
        display: inline-block;
        padding: .25rem .5rem;
        border-radius: .5rem;
        background: rgba(0,0,0,.06);
        font-weight: 600;
    }
</style>

<!-- GEO verisi (Index’teki bindGeoSelectors bunu okuyacak) -->
<script id="geo-data" type="application/json">@Html.Raw(json)</script>

<div class="row g-4">
    <!-- Kişisel Bilgiler -->
    <div class="col-lg-6">
        <div class="card elegant-card h-100">
            <div class="card-header hd-gradient-blue">@Localizer["details.PERSONAL_INFORMATION"]</div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label" for="firstName">@Localizer["details.FIRST_NAME"]</label>
                    <input type="text" class="form-control" id="firstName" placeholder="@Localizer["details.NAME_PLACEHOLDER"]" autocomplete="given-name" />
                </div>
                <div class="mb-3">
                    <label class="form-label" for="lastName">@Localizer["details.LAST_NAME"]</label>
                    <input type="text" class="form-control" id="lastName" placeholder="@Localizer["details.LASTNAME_PLACEHOLDER"]" autocomplete="family-name" />
                </div>
                <div class="mb-3">
                    <label class="form-label" for="email">@Localizer["details.E_MAIL"]</label>
                    <input type="email" class="form-control" id="email" placeholder="@Localizer["details.E_MAIL_PLACEHOLDER"]" autocomplete="email" />
                </div>
                <div class="mb-3">
                    <label class="form-label" for="phone">@Localizer["details.PHONE"]</label>
                    <input type="text" class="form-control" id="phone" placeholder="5xxxxxxxxx" autocomplete="tel" />
                </div>

                <!-- Country / City / County -->
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label" for="countrySelect">@Localizer["details.COUNTRY"]</label>
                        <select class="form-select" id="countrySelect"></select>
                    </div>
                    <div class="col-sm-6">
                        <label class="form-label" for="citySelect">@Localizer["details.CITY"]</label>
                        <select class="form-select" id="citySelect" disabled></select>
                    </div>
                    <div class="col-sm-6">
                        <label class="form-label" for="countySelect">@Localizer["details.COUNTY"]</label>
                        <select class="form-select" id="countySelect" disabled></select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bilet Bilgileri (+ Sepet içeride) -->
    <div class="col-lg-6">
        <div class="card elegant-card h-100">
            <div class="card-header hd-gradient-purple">@Localizer["details.TICKET_INFORMATION"]</div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label" for="ticketType">@Localizer["details.TICKET_TYPE"]</label>
                    <select class="form-select" id="ticketType" @(hasTickets ? null : "disabled")>
                        @if (hasTickets)
                        {
                            foreach (var t in Model)
                            {
                                var name = $"{t.TicketType?.Name} - {t.PriceCategory?.Name}";
                                <option value="@t.Id"
                                        data-name="@name"
                                        data-price="@t.Price"
                                        data-currency-id="@t.CurrencyType.Id"
                                        data-currency-symbol="@t.CurrencyType.Symbol">
                                    @name (@t.Price @t.CurrencyType.Symbol)
                                </option>
                            }
                        }
                    </select>
                    @if (!hasTickets)
                    {
                        <div class="form-text text-danger">@Localizer["details.NO_TICKET_FOR_SESSION"]</div>
                    }
                </div>

                <div class="row g-3 align-items-end">
                    <div class="col-sm-6">
                        <label class="form-label">@Localizer["details.PIECE"]</label>
                        <div class="d-flex align-items-center qty-wrap">
                            <button type="button" class="btn btn-outline-secondary" onclick="changeSelectionQty(-1)" aria-label="@Localizer["details.DECREASE"]">−</button>
                            <input type="text" class="form-control text-center mx-2" style="max-width:90px" id="ticketQty" value="1" @(hasTickets ? null : "disabled") />
                            <button type="button" class="btn btn-outline-secondary" onclick="changeSelectionQty(1)" aria-label="@Localizer["details.INCREASE"]">+</button>
                        </div>
                    </div>

                    <div class="col-sm-6">
                        <label class="form-label" for="currencySelect">@Localizer["details.CURRENCY_TYPE"]</label>
                        <!-- Bilet seçimine göre senkron; manuel değişmesin -->
                        <select class="form-select" id="currencySelect" disabled>
                            @foreach (var c in currencyOptions)
                            {
                                <option value="@c.Id" data-symbol="@c.Symbol">@c.Symbol @c.Name</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Birim Fiyat & Seçim Toplamı + Sepete Ekle -->
                <div class="row g-3 mt-1">
                    <div class="col-sm-4">
                        <label class="form-label" for="unitPrice">@Localizer["details.UNIT_PRICE"]</label>
                        <input type="text" class="form-control" id="unitPrice" readonly value="0" />
                    </div>
                    <div class="col-sm-4">
                        <label class="form-label" for="selectionTotal">@Localizer["details.SELECTION_TOTAL"]</label>
                        <input type="text" class="form-control" id="selectionTotal" readonly value="0" />
                    </div>
                    <div class="col-sm-4 d-flex align-items-end">
                        <button type="button" id="btnAddTicket" class="btn btn-primary w-100" @(hasTickets ? null : "disabled")>
                            @Localizer["details.ADD_TO_CART"]
                        </button>
                    </div>
                </div>

                <div class="card-divider"></div>

                <!-- Sepet (Ticket Information kartı içinde) -->
                <div class="d-flex align-items-center mb-2">
                    <h6 class="mb-0">@Localizer["details.CART"]</h6>
                    <span class="badge bg-dark ms-2" id="cartBadge">0</span>
                </div>

                <div id="cartTotals" class="mb-2 small text-muted"></div>

                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                            <tr>
                                <th>@Localizer["details.PRODUCT"]</th>
                                <th class="text-center">@Localizer["details.PIECE"]</th>
                                <th class="text-end">@Localizer["details.UNIT_PRICE"]</th>
                                <th class="text-end">@Localizer["details.TOTAL_AMOUNT"]</th>
                                <th class="text-end">@Localizer["details.ACTION"]</th>
                            </tr>
                        </thead>
                        <tbody id="cartTableBody"></tbody>
                    </table>
                </div>
                <div class="small text-warning" id="multiCurNote"></div>
            </div>
        </div>
    </div>

    <!-- Ek Ürünler (Ürünler de aynı sepete eklenir) -->
    <div class="col-12">
        <div class="card elegant-card">
            <div class="card-header hd-gradient-purple">
                @Localizer["details.ADDITIONAL_PRODUCTS"]
            </div>
            <div class="card-body">
                <div class="row g-2 align-items-center mb-3">
                    <div class="col-sm-6">
                        <input type="text" class="form-control" placeholder="@Localizer["details.SEARCH"]" oninput="filterProducts(this)" />
                    </div>
                    <div class="col-sm-6 text-sm-end small text-muted">
                        @(hasProducts ? $"{products.Count()} item" : @Localizer["details.NO_PRODUCT"])
                    </div>
                </div>

                <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3" id="productGrid">
                    @if (hasProducts)
                    {
                        foreach (var p in products)
                        {
                            var canBuy = p.Price > 0 && p.CurrencyTypeId > 0;
                            <div class="col">
                                <div class="card prod-card p-3"
                                     data-id="@p.ProductId"
                                     data-name="@p.Name"
                                     data-code="@p.Code"
                                     data-price="@p.Price"
                                     data-currency-id="@p.CurrencyTypeId"
                                     data-symbol="@p.CurrencyTypeSymbol">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="prod-title">@p.Name</div>
                                            <div class="prod-code">#@p.Code</div>
                                        </div>
                                        <span class="price-chip">@p.Price @p.CurrencyTypeSymbol</span>
                                    </div>

                                    <div class="mt-3 d-flex justify-content-between align-items-center">
                                        <div class="qty-wrap d-flex align-items-center">
                                            <button type="button" class="btn btn-outline-secondary btn-sm js-prod-minus" onclick="changeProdQty(this,-1)">−</button>
                                            <input type="text" class="form-control form-control-sm text-center mx-2 prod-qty" style="width:72px" value="1" />
                                            <button type="button" class="btn btn-outline-secondary btn-sm js-prod-plus" onclick="changeProdQty(this,1)">+</button>
                                        </div>
                                        <button type="button"
                                                class="btn btn-primary btn-sm"
                                                onclick="addProductToCart(this)"
                                                @(canBuy ? null : "disabled")
                                                title="@(canBuy ? "" : Localizer["details.NO_PRICE"])">
                                            @Localizer["details.ADD_TO_CART"]
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="col-12">
                            <div class="alert alert-info mb-0">@Localizer["details.NO_PRODUCT"]</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="col-12">
        <div class="card elegant-card">
            <div class="card-header hd-gradient-teal">@Localizer["details.PAYMENT_INFORMATION"]</div>
            <div class="card-body row g-3 align-items-end">
                <div class="col-md-6">
                    <label class="form-label" for="paymentType">@Localizer["details.PAYMENT_TYPE"]</label>
                    <select class="form-select" id="paymentType" @(paymentTypes.Any() ? null : "disabled")>
                        @foreach (var pt in paymentTypes)
                        {
                            <option value="@pt.Id">@pt.Name</option>
                        }
                    </select>
                    @if (!paymentTypes.Any())
                    {
                        <div class="form-text text-danger">@Localizer["details.NO_PAYMENT_TYPE_FOR_LANG"]</div>
                    }
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="totalAmount">@Localizer["details.TOTAL_AMOUNT"]</label>
                    <input type="text" class="form-control" id="totalAmount" readonly value="0" />
                </div>

                <div class="col-12 d-flex justify-content-end gap-2 mt-2">
                    <button type="button" class="btn btn-outline-danger">@Localizer["details.CANCEL"]</button>
                    <button type="button" class="btn btn-primary" onclick="goToConfirmation()">
                        @Localizer["details.CONFIRMATION"]
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>