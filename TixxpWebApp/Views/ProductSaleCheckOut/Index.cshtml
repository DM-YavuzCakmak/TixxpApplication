@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Ürü";
}

<div class="page">
    <!-- Start::app-content -->
    <div class="main-content app-content">
        <div class="container-fluid">

            <!-- Page Header -->
            <div class="d-md-flex d-block align-items-center justify-content-between my-4 page-header-breadcrumb text-fixed-white">
                <h1 class="page-title fw-medium fs-18 mb-0 text-fixed-white">Fatura Bilgileri</h1>
                <div class="ms-md-1 ms-0">
                    <nav>
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item text-fixed-white"><a href="javascript:void(0);" class="text-fixed-white">Satış</a></li>
                            <li class="breadcrumb-item active text-fixed-white" aria-current="page">Ürün Satışı</li>
                        </ol>
                    </nav>
                </div>
            </div>
            <!-- Page Header Close -->
            <!-- Start::row-1 -->
            <div class="row">
                <div class="col-xl-12">
                    <div class="card custom-card">
                        <div class="card-body p-0 product-checkout">
                            <ul class="nav nav-tabs tab-style-2 d-sm-flex d-block border-bottom border-block-end-dashed" id="myTab1" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="order-tab" data-bs-toggle="tab"
                                            data-bs-target="#order-tab-pane" type="button" role="tab"
                                            aria-controls="order-tab" aria-selected="true">
                                        <i class="ri-truck-line me-2 align-middle"></i>Fatura Türü
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="order-summary" data-bs-toggle="tab"
                                            data-bs-target="#order-summary-pane" type="button" role="tab"
                                            aria-controls="order-summary" aria-selected="false">
                                        <i class="ri-bank-card-line me-2 align-middle"></i>Sipariş Özeti
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="delivered-tab" data-bs-toggle="tab"
                                            data-bs-target="#delivery-tab-pane" type="button" role="tab"
                                            aria-controls="delivered-tab" aria-selected="false">
                                        <i class="ri-checkbox-circle-line me-2 align-middle"></i>Confirmation
                                    </button>
                                </li>
                            </ul>
                            <div class="tab-content" id="myTabContent">
                                <!--Fatura Türü -->
                                <div class="tab-pane fade show active border-0 p-0" id="order-tab-pane" role="tabpanel"
                                     aria-labelledby="order-tab-pane" tabindex="0">
                                    <div class="p-4">
                                        @* <p class="mb-1 fw-medium text-muted op-5 fs-20">01</p> *@
                                        <div class="fs-15 fw-medium d-sm-flex d-block align-items-center justify-content-between mb-3">
                                            <div class="mt-sm-0 mt-2">
                                                @* <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modal-new-address"><i class="ri-add-line me-1 align-middle fs-16 fw-medium d-inline-block"></i>Add New Address</button> *@
                                                <div class="modal fade" id="modal-new-address" tabindex="-1" aria-labelledby="modal-new-address" aria-hidden="true">
                                                    <div class="modal-dialog modal-lg modal-dialog-centered">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h6 class="modal-title" id="staticBackdropLabel">
                                                                    New Address
                                                                </h6>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <div class="row gy-3">
                                                                    <div class="col-xl-6">
                                                                        <label for="fullname-new" class="form-label">Full Name</label>
                                                                        <input type="text" class="form-control" id="fullname-new" placeholder="Full Name">
                                                                    </div>
                                                                    <div class="col-xl-6">
                                                                        <label for="email-new" class="form-label">Email</label>
                                                                        <input type="email" class="form-control" id="email-new" placeholder="email">
                                                                    </div>
                                                                    <div class="col-xl-6">
                                                                        <label for="phonenumber-new" class="form-label">Phone Number</label>
                                                                        <input type="number" class="form-control" id="phonenumber-new" placeholder="Phone">
                                                                    </div>
                                                                    <div class="col-xl-6">
                                                                        <label for="address-new" class="form-label">Address</label>
                                                                        <input type="text" class="form-control" id="address-new" placeholder="Address">
                                                                    </div>
                                                                    <div class="col-xl-12">
                                                                        <div class="row">
                                                                            <div class="col-xl-3">
                                                                                <label for="pincode-new" class="form-label">Pincode</label>
                                                                                <input type="number" class="form-control" id="pincode-new" placeholder="Pinicode">
                                                                            </div>
                                                                            <div class="col-xl-3">
                                                                                <label for="city-new" class="form-label">City</label>
                                                                                <input type="text" class="form-control" id="city-new" placeholder="City">
                                                                            </div>
                                                                            <div class="col-xl-3">
                                                                                <label for="state-new" class="form-label">State</label>
                                                                                <input type="text" class="form-control" id="state-new" placeholder="State">
                                                                            </div>
                                                                            <div class="col-xl-3">
                                                                                <label for="country-new" class="form-label">Country</label>
                                                                                <input type="text" class="form-control" id="country-new" placeholder="Country">
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                                                                <button type="button" class="btn btn-success">
                                                                    Save
                                                                    Address
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row gy-4 mb-4">
                                            <!-- Invoice Type Dropdown -->
                                            <div class="col-xl-4">
                                                <label for="invoiceType" class="form-label">Fatura Türü</label>
                                                <select class="form-select" id="invoiceType">
                                                    <option value="">Lütfen Fatura Türü Seçiniz</option>
                                                    @foreach (var item in ViewBag.InvoiceTypes as List<Tixxp.Entities.InvoiceType.InvoiceTypeEntity>)
                                                    {
                                                        <option value="@item.Id">@item.Name</option>
                                                    }
                                                </select>
                                            </div>

                                            <!-- Common for Şahıs + Firma -->
                                            <div class="col-xl-4 d-none" id="nationalIdGroup">
                                                <label for="nationalId" class="form-label">T.C. Kimlik No</label>
                                                <input type="text" class="form-control" id="nationalId" placeholder="T.C. Kimlik No" />
                                            </div>

                                            <!-- Firma-specific fields -->
                                            <div class="col-xl-4 d-none" id="companyNameGroup">
                                                <label for="companyName" class="form-label">Firma Adı</label>
                                                <input type="text" class="form-control" id="companyName" placeholder="Firma Adı" />
                                            </div>

                                            <div class="col-xl-4 d-none" id="taxNumberGroup">
                                                <label for="taxNumber" class="form-label">Vergi Numarası</label>
                                                <input type="text" class="form-control" id="taxNumber" placeholder="Vergi No" />
                                            </div>

                                            <div class="col-xl-4 d-none" id="taxOfficeGroup">
                                                <label for="taxOffice" class="form-label">Vergi Dairesi</label>
                                                <input type="text" class="form-control" id="taxOffice" placeholder="Vergi Dairesi" />
                                            </div>

                                            <!-- Country, City, Province - Common for Firma + Şahıs -->
                                            <div class="col-xl-4 d-none" id="countryGroup">
                                                <label for="country" class="form-label">Ülke</label>
                                                <select class="form-select" id="country">
                                                    <option value="">Seçiniz</option>
                                                    <option value="TR">Türkiye</option>
                                                    <option value="US">ABD</option>
                                                </select>
                                            </div>

                                            <div class="col-xl-4 d-none" id="cityGroup">
                                                <label for="city" class="form-label">Şehir</label>
                                                <select class="form-select" id="city">
                                                    <option value="">Seçiniz</option>
                                                    <option value="İstanbul">İstanbul</option>
                                                    <option value="Ankara">Ankara</option>
                                                </select>
                                            </div>

                                            <div class="col-xl-4 d-none" id="provinceGroup">
                                                <label for="province" class="form-label">İlçe</label>
                                                <select class="form-select" id="province">
                                                    <option value="">Seçiniz</option>
                                                    <option value="Kadıköy">Kadıköy</option>
                                                    <option value="Çankaya">Çankaya</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="px-4 py-3 border-top border-block-start-dashed d-sm-flex justify-content-end">
                                        <button type="button" class="btn btn-success-light d-none" id="personal-details-trigger">
                                            Personal Details<i class="ri-user-3-line ms-2 align-middle d-inline-block"></i>
                                        </button>
                                    </div>
                                </div>
                                <!--Fatura Türü -->

                                <!--Sipariş Özeti -->
                                <div class="tab-pane fade border-0 p-0" id="order-summary-pane" role="tabpanel"
                                     aria-labelledby="order-summary-pane" tabindex="0">
                                    <div class="p-4">
                                        @* <p class="mb-1 fw-medium text-muted op-5 fs-20">04</p> *@
                                        <div class="fs-15 fw-medium d-sm-flex d-block align-items-center justify-content-between mb-3">
                                            <div>Sipariş Özeti :</div>
                                        </div>
                                        <div class="row justify-content-center">
                                            <div class="col-xl-6">
                                                <div class="card custom-card border">
                                                    <div class="card-header">
                                                        <div class="card-title me-1">Sipariş Özeti</div><span class="badge bg-info-transparent rounded-pill">03</span>
                                                    </div>
                                                    <div class="card-body p-0">
                                                        <ul class="list-group mb-0 border-0 rounded-0" id="order-summary-list">
                                                           
                                                        </ul>
                                                        <div class="p-3 border-bottom border-block-end-dashed">
                                                            <div class="d-flex align-items-center justify-content-between mb-3">
                                                                <div class="text-muted">Ara Toplam</div>
                                                                <div class="fw-medium fs-14" id="subtotal-amount">$0</div>
                                                            </div>
                                                        </div>
                                                        <div class="p-3">
                                                            <div class="d-flex align-items-center justify-content-between">
                                                                <div class="fs-15">Toplam :</div>
                                                                <div class="fw-medium fs-18 text-dark" id="total-amount">$0</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="px-4 py-3 border-top border-block-start-dashed d-sm-flex justify-content-between">
                                        <button type="button" class="btn btn-danger-light m-1" id="back-personal-trigger"><i class="ri-user-3-line me-2 align-middle d-inline-block"></i>Fatura Türü Seçimine Geri Dön</button>
                                        <button type="button" class="btn btn-success-light m-1" id="continue-payment-trigger">Ödeme Yap<i class="bi bi-credit-card-2-front align-middle ms-2 d-inline-block"></i></button>
                                    </div>
                                </div>
                                <!--Sipariş Özeti -->


                                <!--Ödeme Sonuç-->
                                <div class="tab-pane fade border-0 p-0" id="delivery-tab-pane" role="tabpanel"
                                     aria-labelledby="delivery-tab-pane" tabindex="0">
                                    <div class="p-5 checkout-payment-success my-3">
                                        <div class="mb-5">
                                            <h5 class="text-success fw-medium">Ödeme Başırılı...&#129309;</h5>
                                        </div>
                                        <div class="mb-5">
                                            <img src="../assets/images/ecommerce/png/6.png" alt="" class="img-fluid">
                                        </div>
                                    @*     <div class="mb-4">
                                            <p class="mb-1 fs-14">You can track your order with Order Id <b>SPK#1FR</b> from <a class="link-success" href="javascript:void(0);"><u>Track Order</u></a></p>
                                            <p class="text-muted">Thank you for shopping with us.</p>
                                        </div> *@
                                        <a href="/ProductSale/Index" class="btn btn-success">Ürün Satışı<i class="bi bi-cart ms-2"></i></a>
                                    </div>
                                </div>
                                <!--Ödeme Sonuç-->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--End::row-1 -->
        </div>
    </div>
    <!-- End::app-content -->
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const invoiceTypeSelect = document.getElementById("invoiceType");
            const personalBtn = document.getElementById("personal-details-trigger");

            const nationalId = document.getElementById("nationalId");
            const companyName = document.getElementById("companyName");
            const taxNumber = document.getElementById("taxNumber");
            const taxOffice = document.getElementById("taxOffice");
            const country = document.getElementById("country");
            const city = document.getElementById("city");
            const province = document.getElementById("province");

            const nationalIdGroup = document.getElementById("nationalIdGroup");
            const companyNameGroup = document.getElementById("companyNameGroup");
            const taxNumberGroup = document.getElementById("taxNumberGroup");
            const taxOfficeGroup = document.getElementById("taxOfficeGroup");
            const countryGroup = document.getElementById("countryGroup");
            const cityGroup = document.getElementById("cityGroup");
            const provinceGroup = document.getElementById("provinceGroup");

            function show(...elements) {
                elements.forEach(el => el.classList.remove("d-none"));
            }

            function hide(...elements) {
                elements.forEach(el => el.classList.add("d-none"));
            }

            function isFilled(el) {
                return el && el.value.trim() !== "";
            }

            function isCurrentStepValid() {
                const selectedText = invoiceTypeSelect.options[invoiceTypeSelect.selectedIndex].textContent;
                if (selectedText.includes("Firma")) {
                    return (
                        isFilled(nationalId) &&
                        isFilled(companyName) &&
                        isFilled(taxNumber) &&
                        isFilled(taxOffice) &&
                        isFilled(country) &&
                        isFilled(city) &&
                        isFilled(province)
                    );
                } else if (selectedText.includes("Şahıs")) {
                    return (
                        isFilled(nationalId) &&
                        isFilled(country) &&
                        isFilled(city) &&
                        isFilled(province)
                    );
                } else if (selectedText.includes("Fiş") || selectedText.includes("Nihai")) {
                    return true;
                }
                return false;
            }

            function updateVisibility() {
                const selectedText = invoiceTypeSelect.options[invoiceTypeSelect.selectedIndex].textContent;
                hide(nationalIdGroup, companyNameGroup, taxNumberGroup, taxOfficeGroup, countryGroup, cityGroup, provinceGroup);
                personalBtn.classList.add("d-none");

                if (selectedText.includes("Firma")) {
                    show(nationalIdGroup, companyNameGroup, taxNumberGroup, taxOfficeGroup, countryGroup, cityGroup, provinceGroup);
                } else if (selectedText.includes("Şahıs")) {
                    show(nationalIdGroup, countryGroup, cityGroup, provinceGroup);
                }

                if (isCurrentStepValid()) {
                    personalBtn.classList.remove("d-none");
                    personalBtn.innerHTML = 'Sipariş Özeti<i class="ri-user-3-line ms-2 align-middle d-inline-block"></i>';

                }
            }

            invoiceTypeSelect.addEventListener("change", updateVisibility);
            [nationalId, companyName, taxNumber, taxOffice, country, city, province].forEach(el =>
                el.addEventListener("input", updateVisibility)
            );

            updateVisibility();

            personalBtn.addEventListener("click", function () {
                const nextTab = document.querySelector('#confirmed-tab');
                new bootstrap.Tab(nextTab).show();
            });
        });
    </script>
}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    async function loadOrderSummary(productSaleId) {
        const response = await fetch(`/ProductSaleCheckOut/GetOrderSummary?productSaleId=${productSaleId}`);
        if (!response.ok) {
            Swal.fire("Hata", "Sipariş özeti alınamadı.", "error");
            return;
        }

        const data = await response.json();
        const listContainer = document.getElementById("order-summary-list");
        const subtotalSpan = document.getElementById("subtotal-amount");
        const totalSpan = document.getElementById("total-amount");

        listContainer.innerHTML = "";

        let subtotal = 0;

        data.forEach(item => {
            const itemTotal = item.price * item.quantity;
            subtotal += itemTotal;

            const li = document.createElement("li");
            li.className = "list-group-item border-top-0 border-start-0 border-end-0";
            li.innerHTML = `
                <div class="d-flex align-items-center flex-wrap">
                    <div class="me-2">
                        <span class="avatar avatar-lg bg-light">
                            <img src="../assets/images/ecommerce/jpg/placeholder.jpg" alt="">
                        </span>
                    </div>
                    <div class="flex-fill">
                        <p class="mb-0 fw-medium">${item.productName}</p>
                        <p class="mb-0 text-muted fs-12">Adet: ${item.quantity}</p>
                    </div>
                    <div>
                        <p class="mb-0 fs-16 fw-medium">$${itemTotal.toFixed(2)}</p>
                    </div>
                </div>`;
            listContainer.appendChild(li);
        });

        subtotalSpan.textContent = `$${subtotal.toFixed(2)}`;
        totalSpan.textContent = `$${subtotal.toFixed(2)}`;
    }

    async function postInvoiceInfo(productSaleId) {
        const model = {
            ProductSaleId: Number(productSaleId),
            InvoiceTypeId: Number(document.getElementById("invoiceType").value),
            IdentityNumber: document.getElementById("nationalId").value,
            CompanyName: document.getElementById("companyName").value,
            TaxNumber: document.getElementById("taxNumber").value,
            TaxOffice: document.getElementById("taxOffice").value,
            CountyId: document.getElementById("province").value
                ? Number(document.getElementById("province").value)
                : null
        };

        const response = await fetch('/ProductSaleCheckOut/AddInvoiceInfo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(model)
        });

        if (response.ok) {
            const result = await response.json();
            if (result.isSuccess) {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'Fatura bilgileri başarılı bir şekilde kaydedildi.',
                    showConfirmButton: false,
                    timer: 3000
                });

                const productSaleIdParam = new URLSearchParams(window.location.search).get("productSaleId");
                await loadOrderSummary(productSaleIdParam);

                setTimeout(() => {
                    const nextTab = document.querySelector('#order-summary');
                    new bootstrap.Tab(nextTab).show();
                }, 500);
            } else {
                Swal.fire("Hata", result.message, "error");
            }
        } else {
            Swal.fire("İstek başarısız", "Sunucuya ulaşılamadı.", "error");
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const personalBtn = document.getElementById("personal-details-trigger");
        const productSaleId = new URLSearchParams(window.location.search).get("productSaleId");

        personalBtn.addEventListener("click", function () {
            if (productSaleId)
                postInvoiceInfo(productSaleId);
            else
                Swal.fire("Hata", "Satış bilgisi bulunamadı.", "error");
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const paymentButton = document.getElementById("continue-payment-trigger");

        paymentButton.addEventListener("click", function () {
            Swal.fire({
                icon: 'success',
                title: 'Ödeme başarılı!',
                text: 'Ödemeniz başarıyla alınmıştır.',
                confirmButtonText: 'Tamam',
            }).then(() => {
                const nextTab = document.querySelector('#delivered-tab');
                new bootstrap.Tab(nextTab).show();
            });
        });
    });
</script>

