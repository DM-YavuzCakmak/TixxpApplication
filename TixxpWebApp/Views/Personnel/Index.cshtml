@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@model List<Tixxp.Entities.Personnel.PersonnelEntity>

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .info-bubble {
        position: absolute;
        opacity: 0;
        transition: opacity 0.2s ease;
        background: white;
        border: 1px solid #ccc;
        padding: 12px 16px;
        border-radius: 10px;
        box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999 !important;
        min-width: 200px;
        font-size: 13px;
        color: #333;
        white-space: nowrap;
        display: none;
    }

    .info-bubble.show {
        display: block !important;
        opacity: 1;
    }

    .info-bubble::after {
        content: '';
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        border-width: 5px;
        border-style: solid;
        border-color: transparent transparent white transparent;
    }

    .text-bg-purple {
        background-color: #8e44ad;
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
    }

    .hierarchy-section {
        margin-top: 60px;
    }

    .hierarchy-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        text-align: center;
        color: #6f42c1;
    }

    .hierarchy-tree {
        display: flex;
        justify-content: center;
        overflow-x: auto;
        padding: 20px 0;
    }

    .tree ul {
        position: relative;
        padding-top: 20px;
        display: flex;
        justify-content: center;
        gap: 20px;
    }

    .tree li {
        list-style: none;
        text-align: center;
        position: relative;
        padding: 20px 10px 0 10px;
    }

    .tree li::before,
    .tree li::after {
        content: '';
        position: absolute;
        top: 0;
        border-top: 2px solid #ccc;
        width: 50%;
        height: 20px;
    }

    .tree li::before {
        right: 50%;
        border-right: 2px solid #ccc;
    }

    .tree li::after {
        left: 50%;
        border-left: 2px solid #ccc;
    }

    .tree li:only-child::before,
    .tree li:only-child::after {
        display: none;
    }

    .tree .node {
        display: inline-block;
        background: #8e44ad;
        color: white;
        padding: 10px 18px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        position: relative;
    }

    .tree ul ul::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        border-left: 2px solid #ccc;
        height: 20px;
    }

    .validation-error {
        font-size: 12px;
        margin-top: 4px;
        display: block;
    }
</style>

<div class="main-content app-content">
    <div class="container-fluid">

        <div class="d-md-flex d-block align-items-center justify-content-between my-4 page-header-breadcrumb text-fixed-white">
            <h1 class="page-title fs-18 text-fixed-white">@Localizer["personnel.INDEX.PAGE_TITLE"]</h1>
            <button class="btn btn-primary" onclick="openEditModal(0)">
                @Localizer["personnel.INDEX.NEW_USER"]
            </button>
        </div>

        <div class="card custom-card">
            <div class="card-header">
                <div class="card-title">@Localizer["personnel.INDEX.TABLE_TITLE"]</div>
            </div>

            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered w-100">
                        <thead>
                            <tr>
                                <th>@Localizer["personnel.INDEX.FIRST_NAME"]</th>
                                <th>@Localizer["personnel.INDEX.LAST_NAME"]</th>
                                <th>@Localizer["personnel.INDEX.EMAIL"]</th>
                                <th>@Localizer["personnel.INDEX.ACTION"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model != null && Model.Any())
                            {
                                foreach (var p in Model)
                                {
                                    <tr>
                                        <td>@p.FirstName</td>
                                        <td>@p.LastName</td>
                                        <td>@p.Email</td>
                                        <td>
                                            <div class="d-flex flex-wrap gap-2 align-items-center">

                                                <button type="button" class="btn btn-icon btn-sm btn-light" onclick="openEditModal(@p.Id)">
                                                    <i class="ri-edit-line"></i>
                                                </button>

                                                <button type="button" class="btn btn-icon btn-sm btn-light" onclick="confirmDelete(@p.Id)">
                                                    <i class="ri-delete-bin-line"></i>
                                                </button>

                                                <button type="button" class="btn btn-sm text-white" style="background:#6f42c1" onclick="openAssignRoleModal(@p.Id)">
                                                    <i class="ri-shield-user-line me-1"></i>
                                                    @Localizer["personnel.INDEX.ASSIGN_ROLE"]
                                                </button>

                                                <button type="button" class="btn btn-sm text-white" style="background:#9b59b6" onclick="showRoles(@p.Id)">
                                                    <i class="ri-eye-line me-1"></i>
                                                    @Localizer["personnel.INDEX.SHOW_ROLES"]
                                                </button>

                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4" class="text-center">
                                        @Localizer["personnel.INDEX.NO_RECORD"]
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card custom-card mt-5 hierarchy-section">
                <div class="card-header">
                    <div class="card-title hierarchy-title">
                        @Localizer["personnel.INDEX.HIERARCHY_TITLE"]
                    </div>
                </div>
                <div class="card-body">
                    <div id="hierarchyContainer" class="hierarchy-tree"></div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Show Roles Modal -->
<div class="modal fade" id="showRolesModal">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">
            <div class="modal-header bg-light p-3">
                <h5 class="modal-title">@Localizer["personnel.INDEX.ROLES_OF_USER"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="roleTagsContainer" class="d-flex flex-wrap gap-2"></div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editPersonnelModal">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">

            <div class="modal-header bg-light p-3">
                <h5 class="modal-title">@Localizer["personnel.INDEX.USER_INFO"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="editPersonnelForm">
                    <input type="hidden" id="editId" name="Id" />

                    <div class="mb-3">
                        <label class="form-label">@Localizer["personnel.INDEX.FIRST_NAME_LABEL"]</label>
                        <input class="form-control" name="FirstName" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">@Localizer["personnel.INDEX.LAST_NAME_LABEL"]</label>
                        <input class="form-control" name="LastName" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">@Localizer["personnel.INDEX.EMAIL_LABEL"]</label>
                        <input type="email" class="form-control" name="Email" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">@Localizer["personnel.INDEX.PHONE_LABEL"]</label>
                        <input class="form-control"
                               name="Phone"
                               id="phoneInput"
                               maxlength="10"
                               inputmode="numeric"
                               oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">@Localizer["personnel.INDEX.PASSWORD_LABEL"]</label>
                        <input type="password" class="form-control" name="Password" required />
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        @Localizer["personnel.INDEX.SAVE"]
                    </button>
                </form>
            </div>

        </div>
    </div>
</div>

<!-- Assign Role Modal -->
<div class="modal fade" id="assignRoleModal">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">

            <div class="modal-header bg-light p-3">
                <h5 class="modal-title">@Localizer["personnel.INDEX.ASSIGN_ROLE"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="assignRoleForm">
                    <input type="hidden" id="assignRolePersonnelId" name="PersonnelId" />

                    <div class="mb-3">
                        <label>@Localizer["personnel.INDEX.SELECT_ROLE"]</label>
                        <select class="form-control" id="roleSelect" name="RoleId" required>
                            <option value="">@Localizer["personnel.INDEX.SELECT_ROLE_PLACEHOLDER"]</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        @Localizer["personnel.INDEX.SAVE"]
                    </button>
                </form>
            </div>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    /* ------------------------
       HIERARCHY TREE
    -------------------------*/

    function loadHierarchyTree() {
        $.get('/Personnel/GetHierarchyTree', function (res) {
            if (!res.success) {
                $('#hierarchyContainer').html(
                    '<p class="text-danger">@Localizer["personnel.INDEX.HIERARCHY_ERROR"]</p>'
                );
                return;
            }
            $('#hierarchyContainer').html(renderTree(res.data));
        });
    }

    function renderTree(nodes) {
        if (!nodes || !nodes.length)
            return '';

        var html = '<ul>';

        nodes.forEach(function (n) {
            html += '<li>';
            html += '<div class="node" onclick="toggleInfoBubble(' + n.id + ')">';
            html += n.name;
            html += '<div class="info-bubble" id="bubble-' + n.id + '">';
            html += '<span class="text-muted">@Localizer["personnel.INDEX.HIERARCHY_LOADING"]</span>';
            html += '</div>'; // info-bubble
            html += '</div>'; // node

            html += renderTree(n.children);

            html += '</li>';
        });

        html += '</ul>';

        return '<div class="tree">' + html + '</div>';
    }

    function toggleInfoBubble(id) {
        $('.info-bubble').hide();
        var bubble = $('#bubble-' + id);
        bubble.show();

        if (bubble.data('loaded'))
            return;

        $.get('/Personnel/GetById', { id: id }, function (res) {
            if (!res.success) {
                bubble.html('<span class="text-danger">@Localizer["personnel.INDEX.BUBBLE_ERROR"]</span>');
                return;
            }

            var d = res.data;

            var html = '<strong>' + d.firstName + ' ' + d.lastName + '</strong><br/>' +
                'Email: ' + d.email + '<br/>' +
                'Phone: ' + (d.phone || '-');

            bubble.html(html);
            bubble.data('loaded', true);
        });
    }

    $(document).ready(function () {
        loadHierarchyTree();
    });

    /* ------------------------
       EDIT MODAL
    -------------------------*/

    function openEditModal(id) {
        if (id === 0) {
            $('#editPersonnelForm')[0].reset();
            $('#editId').val('');
            $("input[name='Password']").prop('required', true);
            $('#editPersonnelModal').modal('show');
            return;
        }

        $.get('/Personnel/GetById', { id: id }, function (res) {
            if (!res.success) {
                Swal.fire('Error', res.message, 'error');
                return;
            }

            var d = res.data;

            $('#editId').val(d.id);
            $("input[name='FirstName']").val(d.firstName);
            $("input[name='LastName']").val(d.lastName);
            $("input[name='Email']").val(d.email);
            $("input[name='Phone']").val(d.phone);
            $("input[name='Password']").val('******').prop('required', false);

            $('#editPersonnelModal').modal('show');
        });
    }

    /* ------------------------
       VALIDATION
    -------------------------*/

    function validatePersonnelForm() {
        var isValid = true;
        $('.validation-error').remove();

        var firstName = $("input[name='FirstName']").val().trim();
        var lastName = $("input[name='LastName']").val().trim();
        var email = $("input[name='Email']").val().trim();
        var phone = $("input[name='Phone']").val().trim();
        var password = $("input[name='Password']").val().trim();
        var id = $('#editId').val();

        var nameRegex = /^[a-zA-ZşŞıİçÇöÖüÜĞğ\s]+$/;

        if (!nameRegex.test(firstName)) {
            addError('FirstName', 'Lütfen geçerli bir ad giriniz.');
            isValid = false;
        }

        if (!nameRegex.test(lastName)) {
            addError('LastName', 'Lütfen geçerli bir soyad giriniz.');
            isValid = false;
        }

        var emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
        if (!emailRegex.test(email)) {
            addError('Email', 'Lütfen geçerli bir email adresi giriniz.');
            isValid = false;
        }

        if (phone && !/^[0-9]{10}$/.test(phone)) {
            addError('Phone', 'Telefon 10 haneli olmalıdır.');
            isValid = false;
        }

        if (!id && password.length < 6) {
            addError('Password', 'Parola en az 6 karakter olmalıdır.');
            isValid = false;
        }

        return isValid;
    }

    function addError(inputName, message) {
        var input = $("input[name='" + inputName + "']");
        input.after('<small class="validation-error text-danger">' + message + '</small>');
    }

    /* ------------------------
       SAVE
    -------------------------*/

    $('#editPersonnelForm').submit(function (e) {
        e.preventDefault();

        if (!validatePersonnelForm()) {
            return;
        }

        var passInput = $("input[name='Password']");
        if (passInput.val() === '******') {
            passInput.prop('disabled', true);
        }

        var formData = $(this).serialize();
        passInput.prop('disabled', false);

        $.post('/Personnel/Save', formData, function (res) {
            if (res.success) {
                Swal.fire('Success', res.message, 'success')
                    .then(function () { location.reload(); });
            } else {
                Swal.fire('Error', res.message, 'error');
            }
        });
    });

    /* ------------------------
       DELETE
    -------------------------*/

    function confirmDelete(id) {
        Swal.fire({
            title: '@Localizer["personnel.INDEX.DELETE_CONFIRM_TITLE"]',
            text: '@Localizer["personnel.INDEX.DELETE_CONFIRM_TEXT"]',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '@Localizer["personnel.INDEX.DELETE_CONFIRM_YES"]',
            cancelButtonText: '@Localizer["personnel.INDEX.DELETE_CONFIRM_CANCEL"]'
        }).then(function (result) {

            if (!result.isConfirmed) return;

            $.post('/Personnel/Delete', { id: id }, function (res) {
                if (res.success) {
                    Swal.fire('@Localizer["personnel.INDEX.DELETED"]', res.message, 'success')
                        .then(function () { location.reload(); });
                } else {
                    Swal.fire('Error', res.message, 'error');
                }
            });
        });
    }

    /* ------------------------
       SHOW ROLES
    -------------------------*/

    function showRoles(personnelId) {
        $.get('/Personnel/GetRolesByPersonnelId', { personnelId: personnelId }, function (res) {
            var container = $('#roleTagsContainer');
            container.html('');

            if (res.success && res.data && res.data.length > 0) {
                res.data.forEach(function (role) {
                    container.append('<span class="text-bg-purple">' + role.name + '</span>');
                });
            } else {
                container.append('<p>@Localizer["personnel.INDEX.NO_ROLE_FOUND"]</p>');
            }

            $('#showRolesModal').modal('show');
        });
    }

    /* ------------------------
       ASSIGN ROLE
    -------------------------*/

    function openAssignRoleModal(personnelId) {
        $('#assignRolePersonnelId').val(personnelId);

        $.get('/Personnel/GetAllRole', function (res) {
            var roleSelect = $('#roleSelect');
            roleSelect.html('');

            if (res.success && res.data && res.data.length > 0) {
                roleSelect.append('<option value="">@Localizer["personnel.INDEX.SELECT_ROLE_PLACEHOLDER"]</option>');
                res.data.forEach(function (role) {
                    roleSelect.append('<option value="' + role.id + '">' + role.name + '</option>');
                });
            } else {
                roleSelect.append('<option value="">@Localizer["personnel.INDEX.NO_ROLE_FOUND"]</option>');
            }

            $('#assignRoleModal').modal('show');
        });
    }

    $('#assignRoleForm').submit(function (e) {
        e.preventDefault();

        $.post('/Personnel/AssignRole', $(this).serialize(), function (res) {
            if (res.success) {
                Swal.fire('Success', res.message, 'success')
                    .then(function () { $('#assignRoleModal').modal('hide'); });
            } else {
                Swal.fire('Error', res.message, 'error');
            }
        });
    });
</script>
